<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SMAUG: Building a custom operator</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SMAUG
   </div>
   <div id="projectbrief">Simulating Machine Learning Applications on gem5-Aladdin</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">The SMAUG C++ API</a></li>  </ul>
</div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building a custom operator </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this document, we will describe how to build a custom operator with a custom hardware accelerator model implementing the logic.</p>
<h1><a class="anchor" id="backends"></a>
SMAUG backends</h1>
<p>A backend is a way to logically group together a set of related operators and/or enforce shared properties on instantiations of operators. For example, a backend may logically require that operators share a common set of compute resources/global variables, impose the same zero-padding requirements on data, and more. SMAUG ships with two backends:</p>
<ul>
<li>Reference: reference implementations of all operators supported in SMAUG. These are intended to be correct, not fast.</li>
<li>SMV: operators implementations based on the SMV chip taped out by the Harvard Architecture, Circuits, and Compilers research group in 2018. These are models of accelerators with 8-wide 16-bit vectorized datapaths. The SIMD datapaths require data to be properly aligned first.</li>
</ul>
<p>Backends are classes comprised purely of static functions and variables. They are defined in <a class="el" href="backend_8h_source.html">core/backend.h</a> and <a class="el" href="backend_8cpp_source.html">core/backend.cpp</a>. Backend classes are used as template parameters to <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a> subclasses, so they must be statically interchangeable. Thus, all backend definitions must statically define the same set of functions and variables, which means that they must also support every operator type.</p>
<p>After building your custom <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a>, you will need to include and register the new operator in those files. We will discuss this more once we get to that step.</p>
<h1><a class="anchor" id="operator"></a>
The Operator class</h1>
<p>When SMAUG reads the model topology proto, it creates named <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a> objects and places them in a global <a class="el" href="classsmaug_1_1Workspace.html" title="Workspace is the container and owner of all Tensors and Operators in the Network.">Workspace</a>. Any <a class="el" href="classsmaug_1_1Tensor.html" title="Tensor represents a single multi-dimensional array of data.">Tensor</a> or <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a> can be looked up by name in the workspace. By convention, SMAUG first creates an empty <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a> of the appropriate type with a common constructor signature, then uses type-specific setters to fill in all the parameters. After all operators are constructed, SMAUG automatically adds edges in the graph to link dependent operators together. For example, here is a typical operator construction pattern (see <a class="el" href="network__builder_8cpp_source.html">network_builder.cpp</a> for more examples):</p>
<div class="fragment"><div class="line">ConvolutionOp&lt;Backend&gt;* op = Backend::createConvolutionOp(name, workspace);</div>
<div class="line">op-&gt;setWeightDims(1,2,3,4);</div>
<div class="line">op-&gt;setPadding(smaug::PaddingType::SAME);</div>
<div class="line"><span class="comment">// Set the remaining operator parameters...</span></div>
<div class="line">network-&gt;addOperator(op);</div>
</div><!-- fragment --><p>Note that operator constructors are invoked by a <code>Backend::createXXXOperator</code> function (created when registering a new operator in the backend). Every <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a>'s constructor must accept the same two arguments: name and workspace, and it must invoke the parent class's constructor.</p>
<p>More importantly, note that at construction time, we do not set or create tensors as parameters to operators. Instead, we set the dimensions of tensors and create than at a later time. Here, we provided a setter for the dimensions of a 4D convolution's weights - filter size (1x2x3) and number of output feature maps (4). But we do not set the dimensions for the input or output activation tensors. The dimensions of the input tensor depend on the previous operator in the graph, and the dimensions of the output in turn depends on the input. At operator construction time, these relationships are not yet known.</p>
<p>Once all operators are constructed, how does SMAUG connect an output tensor of operator A to the input tensor of operator B? What happens if operator B has many input tensors, each of which have different meanings? The answer is that the base <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a> class contains an ordered list of inputs and outputs. Each operator implementation publishes the number of inputs and outputs it has along with the meaning of each one (e.g. input tensor 0 represents activations and input tensor 1 represents weights). This ordering is reflected in to the Python API and encoded in the model topology proto. SMAUG uses this information to link operators together with the Operator::setInput and Operator::setOutput APIs. This information is typically encoded as enums:</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> {kInputs, kWeights, kNumInputs};</div>
<div class="line"><span class="keyword">enum</span> {kOutput, kNumOutputs};</div>
</div><!-- fragment --><p>Putting this all together, below is a simple example of a custom <a class="el" href="classsmaug_1_1Operator.html" title="Operator is the base class for all graph operators supported by SMAUG.">Operator</a> that has no backend-specific behavior.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;core/operator.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;core/workspace.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacesmaug.html">smaug</a> {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Backend&gt;</div>
<div class="line"><span class="keyword">class </span>MyCustomOperator : <span class="keyword">public</span> Operator {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  MyCustomOperator(<span class="keyword">const</span> std::string&amp; name, Workspace* workspace) :</div>
<div class="line">    Operator(name, workspace) {</div>
<div class="line">      inputs.resize(kNumInputs, <span class="keyword">nullptr</span>);</div>
<div class="line">      outputs.resize(kNumOutputs, <span class="keyword">nullptr</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setParam1(<span class="keywordtype">int</span> val) { param1 = val; }</div>
<div class="line">  <span class="keywordtype">void</span> setParam2(<span class="keywordtype">int</span> val) { param2 = val; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Required overrides. Leave them blank for now; we&#39;ll implement them later.</span></div>
<div class="line">  <span class="keywordtype">void</span> run()<span class="keyword"> override </span>{}</div>
<div class="line">  <span class="keywordtype">void</span> createAllTensors()<span class="keyword"> override </span>{}</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// An optional function to tile the input tensors.</span></div>
<div class="line">  <span class="keywordtype">void</span> tile()<span class="keyword"> override </span>{}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">enum</span> {kInputs, kWeights, kNumInputs};</div>
<div class="line">  <span class="keyword">enum</span> {kOutput, kNumOutputs};</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">int</span> param1 = 0;</div>
<div class="line">  <span class="keywordtype">int</span> param2 = 0;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace smaug</span></div>
</div><!-- fragment --><p>Now we can integrate this custom operator into SMAUG. To do so, we need to make a few more modifications:</p>
<ol type="1">
<li>Add a new <code>OpType</code> enum for this operator to smaug/core/types.proto.</li>
<li>Define the operator in all backends. Simply follow the existing convention in <a class="el" href="backend_8h_source.html">backend.h</a> and <a class="el" href="backend_8cpp_source.html">backend.cpp</a>:<ul>
<li>Include the header file and forward declare the operator in <a class="el" href="backend_8h_source.html">backend.h</a>.</li>
<li>Add <code>DECL_CREATE_OP(MyCustomOperator)</code> to all backends in <a class="el" href="backend_8h_source.html">backend.h</a>.</li>
<li>Add <code>DEF_CREATE_OP(MyCustomOperator, Backend)</code> for all backends in <a class="el" href="backend_8cpp_source.html">backend.cpp</a>.</li>
</ul>
</li>
<li>Update <a class="el" href="network__builder_8cpp_source.html">network_builder.cpp</a> to know about the new operator. This belongs in <code>createAndAddOperator</code>: <div class="fragment"><div class="line"><span class="keywordflow">if</span> (type == OpType::MyCustomOperator) {</div>
<div class="line">  <span class="keyword">auto</span> op = Backend::createMyCustomOperator(name, workspace);</div>
<div class="line">  op-&gt;setParam1(node.param1());</div>
<div class="line">  op-&gt;setParam2(node.param2());</div>
<div class="line">  network-&gt;addOperator(op);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add any new .cpp files to the <code>SRCS</code> variable in smaug/make/Makefile.common.</li>
</ol>
<p>In order to use your new operator in a model, you also need to add an API to create it in the Python API. See the Python documentation for details.</p>
<h1><a class="anchor" id="logic"></a>
Implementing the operator logic</h1>
<p>We've written the skeleton of a new custom operator, but it currently doesn't do anything. Let's suppose that <code>MyCustomOperator</code> will take two tensors and add them elementwise. In this section, we'll learn how to write the function that performs this operation. We'll first learn how to write it to run on a CPU-only (no hardware-acceleration) to familiarize ourselves with SMAUG APIs. Afterwards, we'll modify this to work with the gem5-Aladdin family of tools.</p>
<h2><a class="anchor" id="Software-only"></a>
implementation</h2>
<h2><a class="anchor" id="Hardware-accelerated"></a>
implementation</h2>
<h1><a class="anchor" id="try_it_out"></a>
Try it out</h1>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="anamespacesmaug_html"><div class="ttname"><a href="namespacesmaug.html">smaug</a></div><div class="ttdoc">The smaug namespace is the parent namespace of all C++ code in SMAUG.</div><div class="ttdef"><b>Definition:</b> <a href="backend_8cpp_source.html#l00037">backend.cpp:37</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
